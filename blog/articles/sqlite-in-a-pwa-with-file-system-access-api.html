<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <meta name="application-name" content="Anita"> <meta name="msapplication-TileColor" content="#002346"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/favicon/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon/favicon-16x16.png"> <link rel="manifest" href="/assets/icons/favicon/site.webmanifest"> <link rel="mask-icon" href="/assets/icons/favicon/safari-pinned-tab.svg" color="#5bbad5"> <link rel="shortcut icon" href="/assets/icons/favicon/favicon.ico"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/icons/favicon/browserconfig.xml"> <meta name="theme-color" content="#002346"> <link rel="stylesheet" href="/assets/css/styles-0-14-17.min.css"> <title>SQLite in a PWA with FileSystemAccessAPI</title> <meta name="description" content="How to use a Sqlite database in a PWA with FileSystemAccessAPI"> </head> <body class="text-gray-800 antialiased flex flex-col h-screen justify-between"> <nav class="top-0 absolute z-50 w-full flex flex-wrap items-center justify-between py-3 navbar-expand-lg bg-gradient-to-r from-prussian-blue-400 to-prussian-blue-700"> <div class="container px-4 mx-auto flex flex-wrap items-center justify-between z-50"> <div class="w-full relative flex justify-between lg:w-auto lg:static lg:block lg:justify-start"> <div class="flex-grow relative flex items-center lg:w-auto lg:static"> <a class="text-lg font-bold leading-relaxed inline-block mr-4 py-2 whitespace-no-wrap uppercase text-white" href="/"> <img src="/assets/logo/logo_square.svg" style="height:35px;width:auto" alt="Anita"> </a> <a class="text-lg font-bold leading-relaxed inline-block mr-4 py-2 whitespace-no-wrap uppercase text-white" href="/"> Anita </a> </div> <button class="cursor-pointer text-xl leading-none px-3 py-1 border border-solid border-transparent rounded bg-transparent block lg:hidden outline-none focus:outline-none" type="button" onclick='toggleNavbar("main-collapse-navbar")'> <ion-icon name="menu-outline" class="text-white" style="width:1.5em;height:1.5em"></ion-icon> </button> </div> <div class="lg:flex flex-grow items-center bg-white lg:bg-transparent lg:shadow-none hidden" id="main-collapse-navbar"> <ul class="flex flex-col lg:flex-row list-none lg:ml-auto"> <li class="flex items-center"> <a class="lg:text-white lg:hover:text-gray-300 text-gray-800 px-3 py-4 lg:py-2 flex items-center text-xs uppercase font-bold" href="/blog"> Blog </a> </li> <li class="flex items-center"> <a class="lg:text-white lg:hover:text-gray-300 text-gray-800 px-3 py-4 lg:py-2 flex items-center text-xs uppercase font-bold" href="https://github.com/anita-app/anita"> <span class="inline-block mr-2">Source Code</span> <ion-icon name="logo-github" class="lg:text-gray-300 text-gray-500" style="width:1.5em;height:1.5em"></ion-icon> </a> </li> </ul> </div> </div> </nav> <section class="relative"> <div class="mx-auto pb-20 mt-36 mb-36"> <div class="w-full lg:w-7/12 ml-auto mr-auto p-10 border-1 rounded-md shadow-md"> <article> <div class="pt-2 pb-1 text-justify pr-5 border-b rounded-t"> <h1 class="m-0 font-light">SQLite in a PWA with FileSystemAccessAPI</h1> </div> <p class="text-sm text-gray-500 mb-8 mt-1">Published on 2021/12/1 by ilDon </p> <p>Anita now supports SQLite, which means you can save your data in a local database on your device from a Progressive Web App.</p> <p>This is achieved by using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/File_System_Access_API"><code>FileSystemAccessAPI</code></a>, so the user only needs to choose where to keep the database once, and then the PWA can perform all CRUD operations it needs, with some caveats.</p> <p>Before we proceed further in understanding how this works, let's first clear the air about the reason for implementing SQLite in a PWA with the <code>FileSystemAccessAPI</code>. </p> <p>SQLite is a database that is used to store data in a local file system, and the <code>FileSystemAccessAPI</code> is a way to access that file system. So combining the two a PWA can access the database and perform CRUD operations on it. And because Anita is an offline <s>first</s> only app, that is a very good match.</p> <p>An even better reason, though, is well described by paraphrasing a quote from Michael Crichton's Jurassic Park:</p> <blockquote> <p>I was so preoccupied over whether or not I could, I didn't stop to think if <em>I should</em>.</p> </blockquote> <p>I'll skip the parts on what is and how to use SQLite, and the <code>FileSystemAccessAPI</code>. Both have very good documentation, so I'll just jump straight to the "how to combine the two".</p> <h2 id="sqliteinthebrowser">SQLite in the browser</h2> <p>First, let's start by looking at how to use SQLite in the browser.</p> <p>Normally, in NodeJS you can use the NPM package <a href="https://www.npmjs.com/package/sqlite"><code>sqlite</code></a>. In a PWA however, it won't work because it relies on bindings that are not available in the browser.</p> <p>Luckily enough, there is an excellent library called <a href="https://www.npmjs.com/package/sql.js"><code>sql.js</code></a> that is precisely aimed at making SQLite work in the browser. So we can use it to create a database in the browser, without having to reinvent the wheel to perform CRUD operations on the database.</p> <h2 id="letscreateadatabase">Let's create a database</h2> <p>To create a database, we need to import the <code>sql.js</code> library and create a new database. I'll skip the details of how to do this, for an in-depth guide, see the docs for <a href="https://sql.js.org/documentation/"><code>sql.js</code></a>.</p> <p>The first time we do this we can simply initialize an empty database, so we do not need (yet) to use the <code>FileSystemAccessAPI</code>:</p> <div class="code-block"><pre class="d"><code>import initSqlJs from 'sql.js';
const SQL = await initSqlJs({
  locateFile: () =&gt; '/path-to-the-wasm-file/sql-wasm.wasm'
});
const db = new SQL.Database();
</code></pre></div> <p>Then we can perform CRUD operations on the database:</p> <div class="code-block"><pre class="d"><code>db.run("CREATE TABLE IF NOT EXISTS people (name TEXT, age INT)");
</code></pre></div> <p>And that's it. We are using SQLite in the browser thanks to the <code>sql.js</code> library.</p> <p>The only downside, so far, is that the <code>db</code> is only stored in memory, and will be lost when the browser is closed.</p> <p>And here is where the <code>FileSystemAccessAPI</code> comes in.</p> <h2 id="letsusethefilesystemaccessapitostorethedatabaseonthedevice">Let's use the <code>FileSystemAccessAPI</code> to store the database on the device</h2> <p>To write to the file system with the <code>FileSystemAccessAPI</code> we need to get a <code>FileSystemFileHandle</code> <code>Object</code>. We will see later how to get one, first let's see how the <code>fileHandle</code> works for writing to the file system.</p> <p>The <code>FileSystemFileHandle</code> <code>Object</code> has a convenient method <code>write</code> that we can use to write to the file. It accepts data in the form of:</p> <div class="code-block"><pre class="d"><code>FileSystemWriteChunkType = BufferSource | Blob | string;
</code></pre></div> <p>So first, we need to export the database to a readable buffer. To do so, <code>sql.js</code> provides a function called <code>export</code>:</p> <div class="code-block"><pre class="d"><code>const binaryArray: Uint8Array = db.export();
</code></pre></div> <p>And now we can use the <code>FileSystemAccessAPI</code> to save the database to the device. </p> <p>Note that we need to ask for permission to access a directory, not a single file. That is because we can't write in place to the db (see <a href="https://wicg.github.io/file-system-access/#api-filesystemdirectoryhandle-removeentry">here</a>, ISSUE 6). As a consequence, when we will update the contents of the file, we will need to get a "new" <code>FileSystemFileHandle</code> that is in sync with the object in memory, otherwise we will get the following error: </p> <blockquote> <p>An operation that depends on state cached in an interface object was made but the state had changed since it was read from disk.</p> </blockquote> <p>So we proceed by first getting a <code>FileSystemDirectoryHandle</code> <code>Object</code>:</p> <div class="code-block"><pre class="d"><code>const dirHandle = window.showDirectoryPicker();
</code></pre></div> <p>To reload the database on new browser sessions, we will want to store the <code>dirHandle</code> in the browser's local storage or in the IndexedDB. This goes beyond the scope of this post, but you can find a good example of this in the <a href="https://github.com/anita-app/anita">source code of Anita</a>, where we store it in the IndexedDB.</p> <p>So from now on, we assume that we have a <code>FileSystemDirectoryHandle</code> <code>Object</code> and we can use it to create a file.</p> <p>So let's now use <code>dirHandle</code> to create a file and store there the database:</p> <div class="code-block"><pre class="d"><code>const fileHandle = await dirHandle.getFileHandle('my_data.db', { create: true })
const writable = await fileHandle.createWritable();
await writable.write(binaryArray);
await writable.close();
</code></pre></div> <h2 id="retrievethedatabasefromthedeviceanduseitinthebrowser">Retrieve the database from the device and use it in the browser</h2> <p>Having saved the database on the device, we can now retrieve it from the device and use it in the browser in new sessions. To do so, we will reuse the <code>dirHandle</code> we created in the previous step. In this way the user will not be bothered to select the directory again. </p> <p>Before we can use <code>dirHandle</code> in a new browser session, we need to re-ask the user the permission to access the file system. This is not ideal from a UX perspective, but it's a design choice of the <code>FileSystemAccessAPI</code> that we cannot change. So we need to ask the user again for permission to access the file system:</p> <div class="code-block"><pre class="d"><code>function checkPerm(dirHandle): boolean {
    const opts = {
    writable: true,
    mode: 'readwrite'
  };

  // Check if we already have permission, if so, return
  if (await dirHandle.queryPermission(opts) === 'granted')
    return true;

  // Request permission to the file, if the user grants permission, return true.
  if (await dirHandle.requestPermission(opts) === 'granted')
    return true;
}
</code></pre></div> <p>Now we can load the database:</p> <div class="code-block"><pre class="d"><code>const fileHandle = await dirHandle.getFileHandle('my_data.db');
const file = await fileHandle.getFile();
const arrayBuffer = await file.arrayBuffer();
// sql.js expects a Uint8Array
const dbAsUint8Array = new Uint8Array(arrayBuffer);
</code></pre></div> <p>And finally, we can “reload” our existing database in the browser:</p> <div class="code-block"><pre class="d"><code>const SQL = await initSqlJs({
  locateFile: () =&gt; '/path-to-the-wasm-file/sql-wasm.wasm'
});
// By passing the Uint8Array, we are initializing the database with the data from the device
db = new SQL.Database(dbAsUint8Array);
</code></pre></div> <p>Now we have all our data available back in our PWA, and we can perform CRUD operations on it. </p> <p>Whenever we want to update the database, we can simply call again <code>db.export()</code> and all the related logic shown above and store the result in the device.</p> <h2 id="finalthoughts">Final thoughts</h2> <p>Implementing SQLite in the browser with persistent data stored on the device thanks to the <code>FileSystemAccessAPI</code> has been quite interesting, and incredibly easy thanks to <code>sql.js</code>.</p> <p>There are, however, some drawbacks, that probably should discourage most from using this solution in a data intensive app in production:</p> <ul> <li>The <code>FileSystemAccessAPI</code> is available only in very few selected browsers, so until broader adoption is achieved, it will be available <a href="https://web.dev/file-system-access/#browser-support">only to Chrome (and Chromium based browsers</a> other than <a href="https://github.com/brave/brave-browser/issues/11407">Brave</a>).<ul> <li>-&gt; Broader adoption is needed</li></ul></li> <li>Even in Browsers that do support the <code>FileSystemAccessAPI</code>, we can't load data automatically when the app is loaded. For security reasons we need to ask the user for permission to access the file system at each new session, and we can't prompt the user for permission without a prior user action (<code>click</code> event). <ul> <li>-&gt; This could be improved if the <code>FileSystemAccessAPI</code> allowed the user to grant permissions once and for all.</li></ul></li> <li>All the data is stored in memory while being used in the browser. Large datasets might cause memory issues. <ul> <li>-&gt; This could be improved if we could write in place to the database, but this is not possible with the <code>FileSystemAccessAPI</code> (see above).</li></ul></li> </ul> <p>Hopefully these issues will be solved in the future, in the meanwhile have fun with <code>sql.js</code> and the <code>FileSystemAccessAPI</code>!</p> </article> </div> </div> </section> <footer class="relative bg-gray-300 pt-8 pb-6"> <div class="bottom-auto top-0 left-0 right-0 w-full absolute pointer-events-none overflow-hidden -mt-20" style="height:80px;transform:translateZ(0)"> <svg class="absolute bottom-0 overflow-hidden" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" version="1.1" viewBox="0 0 2560 100" x="0" y="0"> <polygon class="text-gray-300 fill-current" points="2560 0 2560 100 0 100"></polygon> </svg> </div> <div class="container mx-auto px-4"> <div class="flex flex-wrap items-center md:justify-left justify-left"> <div class="w-6/12 md:w-4/12"> <button class="bg-white text-gray-900 shadow-lg font-normal h-10 w-10 items-center justify-center align-center rounded-full outline-none focus:outline-none mr-2" onclick='window.open("https://github.com/anita-app/anita","_blank")'> <ion-icon name="logo-github" class="mt-1" style="width:1.5em;height:1.5em"></ion-icon> </button> </div> <div class="w-6/12 md:w-4/12 text-right md:text-center py-1"> <div class="flex justify-center text-sm text-gray-600 font-semibold"> Developed with <ion-icon name="heart-outline" class="text-red-800 self-end ml-1 mr-1" style="width:1.2em;height:1.2em"></ion-icon> by humans & <a href="https://copilot.github.com/" target="_blank" class="ml-1"><u>GitHub Copilot</u></a>, </div> <div class="text-sm text-gray-600 font-semibold"> made possible by <a href="/licenses.html"><u>open source</u></a>. </div> </div> </div> </div> <script src="/assets/js/main-0-14-17.min.js"></script> <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script> <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script> <script data-goatcounter="https://anita.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script> </footer> </body> </html>